<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>走れ文学 - 作文用紙とメロス</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 日本語フォント設定 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #87CEEB; /* スカイブルー */
            overflow: hidden; /* 全体のスクロールを禁止 */
        }

        /* ---------------------------------------------------- */
        /* 作文用紙エリアのスタイル */
        /* ---------------------------------------------------- */
        .composition-paper {
            width: 80%;
            max-width: 900px;
            height: 400px;
            margin: 20px auto;
            padding: 30px;
            background-color: #FFFFF0; /* クリーム色 */
            border: 5px solid #F0E68C; /* 薄い金色の縁取り */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            position: relative;
        }

        /* 縦書き設定 */
        #story-container {
          position: absolute;   /* 紙の右上を基点にする */
          top: 30px;            /* 紙の padding に合わせて調整 */
          right: 30px;
          writing-mode: vertical-rl;
          text-orientation: upright;
          font-size: 1.5rem;
          line-height: 2.5rem;
          letter-spacing: 0.1rem;
          color: #333;
          white-space: pre-wrap;
          padding: 0;           /* 左寄せ要素を消す */
          width: auto;
          height: calc(100% - 60px); /* 下に余白を残すなら */
        }
        
        .story-paragraph {
            display: inline-block;
            margin-right: 2.5rem;
            padding-top: 10px;
            padding-bottom: 10px;
            min-height: 100%;
            vertical-align: top;
        }

        /* ---------------------------------------------------- */
        /* ステージエリアのスタイル */
        /* ---------------------------------------------------- */
        .stage-container {
            width: 100%;
            height: 200px;
            position: fixed;
            bottom: 0;
            left: 0;
            background-color: #008000; /* 濃い緑の地面 */
            z-index: 5;
        }

        /* メロス（キャラクター）のスタイル */
        #melos {
            position: absolute;
            bottom: 60px;
            left: 0;
            width: 80px;
            z-index: 10;
        }

        /* 段落送りボタンのスタイル */
        #next-paragraph-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #3B82F6;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            z-index: 50;
            transition: background-color 0.3s;
        }
        #next-paragraph-button:hover {
            background-color: #2563EB;
        }
    </style>
</head>
<body>

<div class="composition-paper">
    <div id="story-container"></div>
</div>

<button id="next-paragraph-button" onclick="nextParagraph()">物語を読み込む...</button>

<div class="stage-container">
    <div id="melos" style="display: inline-block;">
        <img src="{{ url_for('static', filename='assets/characters/Melos.jpg') }}"
          alt="メロス"
          style="width: 80px; height: auto; display: block; user-select: none;">
    </div>
</div>

<script>
    // --- 変数定義 ---
    let storyData = [];
    let storyLoaded = false;
    let currentParagraphIndex = 0;
    let currentCharacterIndex = 0;
    let typingIntervalId = null;
    let melosPositionX = 0;

    const storyContainer = document.getElementById("story-container");
    const nextButton = document.getElementById("next-paragraph-button");
    const melos = document.getElementById("melos");

    const initialStory = [
        "メロスは激怒した。",
        "必ずや、かの邪智暴虐の王を除かなければならぬと決意した。"
    ];


    // --- メロス移動アニメーション ---
    function updateMelosPosition() {
        const stageContainer = document.querySelector(".stage-container");
        if (!stageContainer) return;

        const stageWidth = stageContainer.offsetWidth;
        const melosWidth = melos.offsetWidth || 80;

        melosPositionX += 3;
        if (melosPositionX > stageWidth) {
            melosPositionX = -melosWidth;
        }
        melos.style.left = melosPositionX + "px";
        requestAnimationFrame(updateMelosPosition);
    }

    
    /* ----------------------------------------------- */
    /* タイピング処理（音なし・スクロール修正版）         */
    /* ----------------------------------------------- */
    function startTyping(text) {
        if (typingIntervalId) clearInterval(typingIntervalId);

        const paraDiv = document.createElement("div");
        paraDiv.className = "story-paragraph";
        storyContainer.appendChild(paraDiv);

        let displayed = "";
        currentCharacterIndex = 0;
        nextButton.disabled = true;
        nextButton.textContent = "表示中...";

        typingIntervalId = setInterval(() => {
            if (currentCharacterIndex < text.length) {
                displayed += text[currentCharacterIndex];
                paraDiv.textContent = displayed;
                currentCharacterIndex++;

                // --- 自動スクロールの計算 ---
                // 縦書き(vertical-rl)では中身が左に伸びるため、
                // 「(全幅) - (表示幅)」の分だけ【左（マイナス）】にずらす
            const scrollOffset = storyContainer.scrollWidth - storyContainer.clientWidth;
            if (scrollOffset > 0) {
                // はみ出した分だけ左へスライド
                storyContainer.style.transform = `translateX(${scrollOffset}px)`;
            }
        } else {
            clearInterval(typingIntervalId);
            typingIntervalId = null;
            nextButton.disabled = false;
            nextButton.textContent = "次の段落へ";
        }
    }, 80); // タイピング速度
}
    // --- 次の段落へ ---
    // --- 次の段落へ ---
    window.nextParagraph = function () {
        if (!storyLoaded) return;

        if (currentParagraphIndex < storyData.length) {
            // まだ表示していない段落がある場合はタイピング表示
            startTyping(storyData[currentParagraphIndex]);
            currentParagraphIndex++;
        } else {
            // すべての段落を表示し終わった後の処理
            
            // Flask から渡された turn を数値として取得
            const currentTurn = parseInt("{{ turn }}") || 1;

            // 4回目（3回目の選択後の表示）ならエンディングへ
            if (currentTurn >= 4) {
                nextButton.textContent = "結末へ...";
                window.location.href = "{{ url_for('ending') }}";
            } else {
                // 1〜3回目なら選択肢画面へ
                nextButton.textContent = "選択肢へ...";
                window.location.href = "{{ url_for('game') }}";
            }
        }
    };

    // --- 初期化：JSON 読み込み ---
    async function loadStoryJson() {
        try {
            const response = await fetch("{{ url_for('static', filename='data/story.json') }}");
            const jsonData = await response.json();
            
            // 全体のストーリーを構築
            storyData = initialStory.concat(jsonData.story);
            
            // Flaskから渡された現在のターン数を取得
            const turn = parseInt("{{ turn }}") || 1;

            if (turn > 1) {
                // 2ターン目以降なら、最新の1文以外を先に表示しておく
                for (let i = 0; i < storyData.length - 1; i++) {
                    const paraDiv = document.createElement("div");
                    paraDiv.className = "story-paragraph";
                    paraDiv.textContent = storyData[i];
                    storyContainer.appendChild(paraDiv);
                }
                // インデックスを最後の文に合わせる
                currentParagraphIndex = storyData.length - 1;
                nextButton.textContent = "続きを読み進める";
            } else {
                currentParagraphIndex = 0;
                nextButton.textContent = "物語を始める";
            }
            
            storyLoaded = true;
        } catch (error) {
            console.error("JSON 読み込みエラー:", error);
            // JSONがない場合でも動くようにフォールバック
            storyData = initialStory;
            storyLoaded = true;
            nextButton.textContent = "物語を始める";
        }
    }

    async function initializeGame() {
        await loadStoryJson();
        updateMelosPosition();
    }

    initializeGame();
</script>

</body>
</html>