<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>走れ文学 - 作文用紙とメロス</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 日本語フォント設定 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #87CEEB; /* スカイブルー */
            overflow: hidden; /* 全体のスクロールを禁止 */
        }

        /* ---------------------------------------------------- */
        /* 作文用紙エリアのスタイル */
        /* ---------------------------------------------------- */
        .composition-paper {
            width: 80%;
            max-width: 900px;
            height: 400px;
            margin: 20px auto;
            padding: 30px;
            background-color: #FFFFF0; /* クリーム色 */
            border: 5px solid #F0E68C; /* 薄い金色の縁取り */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
            overflow: hidden; /* スクロールをJSで制御するため非表示 */
            position: relative;
        }

        /* 縦書き設定 */
        #story-container {
            writing-mode: vertical-rl; /* 縦書き（右から左へ）*/
            text-orientation: upright;
            font-size: 1.5rem;
            line-height: 2.5rem;
            letter-spacing: 0.1rem;
            color: #333;
            /* テキストが出現する領域 */
            height: 100%; 
            width: fit-content; /* 内容の幅に合わせる */
            white-space: pre-wrap; 
            padding-left: 20px;
            transform-origin: top right; /* 右上を基点にスクロール制御 */
            transition: transform 0.5s ease-out; /* 段落送り時のアニメーション */
        }
        
        .story-paragraph {
            display: inline-block; /* 縦書きで段落を扱う */
            margin-right: 2.5rem; /* 段落間のスペース */
            padding-top: 10px; /* 見た目の調整 */
            padding-bottom: 10px; /* 見た目の調整 */
            min-height: 100%;
            vertical-align: top;
        }

        /* ---------------------------------------------------- */
        /* ステージエリアのスタイル */
        /* ---------------------------------------------------- */
        .stage-container {
            width: 100%;
            height: 200px;
            position: fixed; /* 固定位置に修正 */
            bottom: 0;
            background-color: #008000; /* 濃い緑の地面 */
        }

        /* メロス（キャラクター）のスタイル */
        #melos {
            position: absolute;
            bottom: 30px;
            left: 50px;
            z-index: 10;
        }

        
        /* 渦巻（選択肢トリガー）のスタイル - 見やすい位置に修正 */
        .vortex {
            position: absolute;
            bottom: 30px; 
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, #8A2BE2 0%, #4B0082 100%);
            box-shadow: 0 0 10px 5px #DA70D6;
            z-index: 5;
            animation: pulse 1.5s infinite alternate;
        }

        /* 渦巻のアニメーション */
        @keyframes pulse {
            from { transform: scale(1); opacity: 0.8; }
            to { transform: scale(1.1); opacity: 1; }
        }
        
        /* 段落送りボタンのスタイル */
        #next-paragraph-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #3B82F6; /* Blue-500 */
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            z-index: 50; /* 作文用紙より上 */
            transition: background-color 0.3s;
        }
        #next-paragraph-button:hover {
            background-color: #2563EB; /* Blue-600 */
        }

    </style>
</head>
<body>

<!-- 画面上部: 作文用紙エリア -->
<div class="composition-paper">
    <div id="story-container">
        <!-- JSによって段落が動的に挿入される -->
    </div>
</div>

<!-- 段落送りボタン -->
<button id="next-paragraph-button" onclick="nextParagraph()">次の段落へ</button>

<!-- 画面下部: ステージ/アクションエリア -->
<div class="stage-container">
    <div id="melos">
        <img src="{{ url_for('static', filename='assets/characters/Melos.jpg') }}"
        alt="メロス"
        style="width: 80px; height: auto; user-select: none;">
    </div>
    
    <!-- 渦巻（選択肢トリガー）の例 -->
    <div class="vortex" id="vortex-trigger" style="left: 650px;"></div>
</div>

<!-- 選択肢オーバーレイ（前回コードから省略 - 動作確認が目的） -->
<div id="choice-overlay" style="display: none;">
    <div class="choice-modal">
        <h2 class="text-2xl font-bold mb-4 text-white">感情の渦：選択せよ</h2>
        <p id="choice-context" class="mb-6 text-gray-300">（省略）</p>
        <button onclick="hideChoices()">閉じる</button>
    </div>
</div>


<script>
    let storyData = [];                // ← 空で開始
    let storyLoaded = false;  


    const storyContainer = document.getElementById("story-container");
    const nextButton = document.getElementById("next-paragraph-button");
    const melos = document.getElementById("melos");
    const vortex = document.getElementById("vortex-trigger");

    let currentParagraphIndex = 0;
    let currentCharacterIndex = 0;
    let typingIntervalId = null;

    let melosPositionX = 50;
    const melosSpeed = 10;

    /* ----------------------------------------------- */
    /* メロス移動アニメーション                        */
    /* ----------------------------------------------- */
    function updateMelosPosition() {
        melos.style.left = `${melosPositionX}px`;
        requestAnimationFrame(updateMelosPosition);
        checkCollision();  // ← 毎フレーム当たり判定
    }

    /* ----------------------------------------------- */
    /* タイピング処理                                   */
    /* ----------------------------------------------- */
    function startTyping(text) {
        if (typingIntervalId) clearInterval(typingIntervalId);

        const paraDiv = document.createElement("div");
        paraDiv.className = "story-paragraph";
        storyContainer.appendChild(paraDiv);

        let displayed = "";
        currentCharacterIndex = 0;

        typingIntervalId = setInterval(() => {
            if (currentCharacterIndex < text.length) {
                displayed += text[currentCharacterIndex];
                paraDiv.textContent = displayed;
                currentCharacterIndex++;
            } else {
                clearInterval(typingIntervalId);
                typingIntervalId = null;
                nextButton.disabled = false;
                nextButton.textContent = "次の段落へ";
            }
        }, 100);

        nextButton.disabled = true;
        nextButton.textContent = "表示中...";
    }

    /* ----------------------------------------------- */
    /* 次の段落へ                                       */
    /* ----------------------------------------------- */
    window.nextParagraph = function () {
        if (currentParagraphIndex < storyData.length) {
            startTyping(storyData[currentParagraphIndex]);
            currentParagraphIndex++;
        } else {
            /* ★ 全部読み終わったら /game に飛ぶ */
            window.location.href = "{{ url_for('game') }}";
        }
    };

    /* ----------------------------------------------- */
    /* キー入力：メロス移動                             */
    /* ----------------------------------------------- */
    document.addEventListener("keydown", (event) => {
        const stageWidth = document.querySelector(".stage-container").clientWidth;
        const melosWidth = melos.clientWidth;

        if (event.key === "a" || event.key === "A" || event.key === "ArrowLeft") {
            melosPositionX = Math.max(melosPositionX - melosSpeed, 0);
        }
        if (event.key === "d" || event.key === "D" || event.key === "ArrowRight") {
            melosPositionX = Math.min(melosPositionX + melosSpeed, stageWidth - melosWidth);
        }
    });

    /* ----------------------------------------------- */
    /* ★ 当たり判定（メロス × 渦巻）                     */
    /* ----------------------------------------------- */
    function checkCollision() {
        const melosRect = melos.getBoundingClientRect();
        const vortexRect = vortex.getBoundingClientRect();

        const hit =
            melosRect.right > vortexRect.left &&
            melosRect.left < vortexRect.right &&
            melosRect.bottom > vortexRect.top &&
            melosRect.top < vortexRect.bottom;

        if (hit) {
            showChoiceOverlay();
        }
    }

    /* ----------------------------------------------- */
    /* ★ 渦巻に触れたときのダミー選択肢画面表示           */
    /* （今は閉じるだけでもOK）                          */
    /* ----------------------------------------------- */
    function showChoiceOverlay() {
        const overlay = document.getElementById("choice-overlay");
        overlay.style.display = "flex";
    }

    window.hideChoices = function () {
        document.getElementById("choice-overlay").style.display = "none";
    };

    /* ----------------------------------------------- */
    /* 初期化                                           */
    /* ----------------------------------------------- */
    async function loadStoryJson() {
        try {
            const response = await fetch("{{ url_for('static', filename='data/story.json') }}");
            const jsonData = await response.json();
            storyData = jsonData.story || [];
            storyLoaded = true;
            console.log("JSON ストーリー読み込み完了:", storyData);
        } catch (error) {
            console.error("JSON 読み込みエラー:", error);
        }
    }

    async function initializeGame() {
        await loadStoryJson();     // ← 追加：先にJSON読み込む
        updateMelosPosition();
        nextButton.textContent = "物語を始める";
        nextButton.disabled = false;
    }

    initializeGame();
</script>


</body>
</html>